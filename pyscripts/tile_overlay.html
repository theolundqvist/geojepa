<!DOCTYPE html>
<html>
<head>
    <title>m_3912162_sw_10_060_20220721.tif</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta http-equiv='imagetoolbar' content='no'/>
    <style type="text/css">
        v\:* {behavior:url(#default#VML);}
        html, body { overflow: hidden; padding: 0; height: 100%; width: 100%; font-family: 'Lucida Grande',Geneva,Arial,Verdana,sans-serif; }
        body { margin: 10px; background: #fff; }
        h1 { margin: 0; padding: 6px; border:0; font-size: 20pt; }
        #header { height: 43px; padding: 0; background-color: #eee; border: 1px solid #888; }
        #subheader { height: 12px; text-align: right; font-size: 10px; color: #555;}
        #map { height: 90%; border: 1px solid #888; }
        #mouse-position {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.7);
            padding: 5px;
            border: 1px solid #ccc;
        }
    </style>
    <!-- OpenLayers CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.0.0/legacy/ol.css" type="text/css">
    <!-- LayerSwitcher CSS -->
    <link rel="stylesheet" href="https://unpkg.com/ol-layerswitcher@4.1.1/src/ol-layerswitcher.css" />
</head>
<body>
    <div id="header"><h1>m_3912162_sw_10_060_20220721.tif</h1></div>
    <div id="subheader">Generated by <a href="https://gdal.org/programs/gdal2tiles.html">GDAL2Tiles</a>&nbsp;&nbsp;&nbsp;&nbsp;</div>
    <div id="map" class="map"></div>
    <div id="mouse-position"></div>

    <!-- OpenLayers JS -->
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.0.0/legacy/ol.js"></script>
    <!-- LayerSwitcher JS -->
    <script src="https://unpkg.com/ol-layerswitcher@4.1.1"></script>
    <script type="text/javascript">
        // Initialize Mouse Position Control
        var mousePositionControl = new ol.control.MousePosition({
            className: 'custom-mouse-position',
            target: document.getElementById('mouse-position'),
            undefinedHTML: '&nbsp;',
            coordinateFormat: ol.coordinate.createStringXY(4),
            projection: 'EPSG:3857'
        });

        // Initialize the Map
        var map = new ol.Map({
            controls: ol.control.defaults().extend([mousePositionControl]),
            target: 'map',

            layers: [
                new ol.layer.Group({
                    title: 'Base maps',
                    layers: [
                        new ol.layer.Tile({
                            title: 'OpenStreetMap',
                            type: 'base',
                            visible: true,
                            source: new ol.source.OSM()
                        }),
                        new ol.layer.Tile({
                            title: 'Bing Roads',
                            type: 'base',
                            visible: false,
                            source: new ol.source.BingMaps({
                                key: "INSERT_YOUR_KEY_HERE",
                                imagerySet: 'Road'
                            })
                        }),
                        new ol.layer.Tile({
                            title: 'Bing Aerial',
                            type: 'base',
                            visible: false,
                            source: new ol.source.BingMaps({
                                key: "INSERT_YOUR_KEY_HERE",
                                imagerySet: 'Aerial'
                            })
                        }),
                        new ol.layer.Tile({
                            title: 'Bing Hybrid',
                            type: 'base',
                            visible: false,
                            source: new ol.source.BingMaps({
                                key: "INSERT_YOUR_KEY_HERE",
                                imagerySet: 'AerialWithLabels'
                            })
                        }),
                    ]
                }),
                new ol.layer.Group({
                    title: 'Overlay',
                    layers: [
                        new ol.layer.Tile({
                            title: 'Overlay',
                            extent: [-13511823.857860, 4721284.134782, -13504013.511031, 4731019.610671],
                            source: new ol.source.XYZ({
                                attributions: '',
                                minZoom: 14,
                                maxZoom: 14,
                                url: './{z}/{x}/{-y}.webp',
                                tileSize: [896, 896]
                            })
                        }),
                    ]
                }),
            ],
            view: new ol.View({
                center: [-13507918.684446, 4726151.872727],
                zoom: 14,
            })
        });

        // Add LayerSwitcher Control
        var layerSwitcher = new ol.control.LayerSwitcher({
            activationMode: 'click',
            startActive: false,
            tipLabel: 'Layers', // Optional label for button
            groupSelectStyle: 'children' // Can be 'children' [default], 'group' or 'none'
        });
        map.addControl(layerSwitcher);

        // Create a Vector Layer for Labels
        var labelLayer = new ol.layer.Vector({
            title: 'Labels Overlay',
            source: new ol.source.Vector(),
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 6,
                    fill: new ol.style.Fill({color: 'red'}),
                    stroke: new ol.style.Stroke({color: 'white', width: 2})
                })
            })
        });
        map.addLayer(labelLayer);

        // Function to Convert Tile X,Y,Z to Map Coordinates (Web Mercator)
        function tileXYToMapXY(x, y, z) {
            var tileSize = 256; // Standard tile size
            var initialResolution = 2 * Math.PI * 6378137 / tileSize;
            var resolution = initialResolution / Math.pow(2, z);
            var originShift = 2 * Math.PI * 6378137 / 2.0;

            var mx = x * tileSize * resolution - originShift;
            var my = originShift - y * tileSize * resolution;
            return [mx, my];
        }

        // Alternatively, using Web Mercator tile calculations
        function tileToMapCenter(x, y, z) {
            var projection = 'EPSG:3857';
            var tileSize = 256; // Assuming standard tile size

            var resolution = ol.extent.getWidth(ol.proj.get(projection).getExtent()) / (256 * Math.pow(2, z));
            var originX = ol.proj.get(projection).getExtent()[0];
            var originY = ol.proj.get(projection).getExtent()[3];

            var centerX = originX + (x + 0.5) * tileSize * resolution;
            var centerY = originY - (y + 0.5) * tileSize * resolution;

            return [centerX, centerY];
        }

        // Load and Parse labels.txt
        fetch('labels.txt')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok ' + response.statusText);
                }
                return response.text();
            })
            .then(data => {
                var features = [];
                var lines = data.split('\n');
                lines.forEach(line => {
                    line = line.trim();
                    if (line === '') return; // Skip empty lines
                    var parts = line.split(':');
                    if (parts.length !== 2) return; // Invalid format
                    var zxy = parts[0].split('_');
                    if (zxy.length !== 3) return; // Invalid z_x_y format
                    var z = parseInt(zxy[0].substring(1)); // Remove leading 'z'
                    var x = parseInt(zxy[1]);
                    var y = parseInt(zxy[2]);
                    var value = parseFloat(parts[1]);

                    if (z === 16 && value === 1.0) { // Filter for z=16 and value=1.0
                        var coords = tileToMapCenter(x, y, z);
                        var feature = new ol.Feature({
                            geometry: new ol.geom.Point(coords)
                        });
                        features.push(feature);
                    }
                });
                labelLayer.getSource().addFeatures(features);
            })
            .catch(error => {
                console.error('Error fetching or parsing labels.txt:', error);
            });
    </script>
</body>
</html>
